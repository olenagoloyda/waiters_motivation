<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–†–µ–π—Ç–∏–Ω–≥ –æ—Ñ—ñ—Ü—ñ–∞–Ω—Ç—ñ–≤ ‚Äî –ì–æ—Ä–æ–±–µ—Ü—å</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>–ì–æ—Ä–æ–±–µ—Ü—å —Ä–∞—Ö—É—î</h1>
    <p class="subtitle">–†–µ–π—Ç–∏–Ω–≥ –∑ 01.05 –ø–æ 31.07</p>
    <p id="updatedAt" class="updated-text"></p>

    <table id="ratingTable">
      <thead>
        <tr>
          <th>–û—Ñ—ñ—Ü—ñ–∞–Ω—Ç</th>
          <th>–ë–∞–ª–∏</th>
        </tr>
      </thead>
      <tbody id="ratingBody"></tbody>
    </table>

    <div id="categories"></div>
  </div>

  <script>
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQC-d0h8f7AyLtfngVfwKNDF-HuT2k6Ev5Dec7l_egJMVipEJRN7yThni-yAotlfRnK1MYeXNjU3g07/pub?output=csv';

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const header = lines[0].split(',').map(h => h.trim());
      const rows = lines.slice(2);
      const data = {};

      rows.forEach(row => {
        const values = row.split(',');
        const name = values[0].trim();
        const obj = {};
        header.slice(1).forEach((key, i) => {
          obj[key] = values[i + 1]?.trim();
        });
        data[name] = obj;
      });

      return data;
    }

    function calculateMonthlyPoints(info) {
      const safe = key => Number(info[key]) || 0;
      const isTrue = key => String(info[key] ?? '').trim().toUpperCase() === 'TRUE';
      let total = 0;

      total += safe('signatureChicken') * 2;
      total += safe('newDishes') * 3;
      total += safe('gomin');
      total += safe('googleReviews') * 5;
      total += safe('mediaDays') * 250;
      total += safe('substitution') * 10;
      total += safe('proposal') * 50;

      if (isTrue('highestAverage')) total += 15;
      if (isTrue('highestTips')) total += 300;

      if (isTrue('lowestAverage')) total -= 10;
      if (isTrue('lowestGomin')) total -= 10;
      if (isTrue('lowestNew')) total -= 10;

      total += safe('late') * -10;
      total += safe('negativeReview') * -100;
      total += safe('badShift') * -15;
      total += safe('ignoringGuests') * -50;
      total += safe('noPhone') * -20;
      total += safe('noClubMention') * -30;
      total += safe('badDish') * -10;

      return total;
    }

    function renderCategory(data, key, label, coef) {
      const category = [];

      for (const name in data) {
        const raw = data[name][key] ?? '0';
        const count = Number(raw) || 0;
        const points = count * coef;
        category.push({ name, count, points });
      }

      category.sort((a, b) => b.points - a.points);

      const table = document.createElement('table');
      table.classList.add('category-table');
      const thead = `<thead><tr><th>${label}</th><th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th><th>–ë–∞–ª–∏</th></tr></thead>`;
      let tbody = '<tbody>';

      const hashtags = {
        signatureChicken: '#–∫—É—Ä–∫–æ—Ä–µ–∫–æ—Ä–¥',
        newDishes: '#–º–µ–Ω—é–º–µ–π–∫–µ—Ä',
        gomin: '#–≥–æ–º—ñ–Ω–≥–æ–ª–æ—Å–Ω–æ',
        googleReviews: '#–≤—ñ–¥–≥—É–∫–æ–∑–±—ñ—Ä–Ω–∏–∫',
        mediaDays: '#–µ–∫—Ä–∞–Ω–≥–µ—Ä–æ–π',
        substitution: '#—Ä—è—Ç—ñ–≤–Ω–∏–∫–¥–Ω—è',
        proposal: '#—ñ–¥–µ—è–≤—Ä–æ–±–æ—Ç—É'
      };

      category.forEach((row, i) => {
        const crown = i === 0 ? 'üî• ' : '';
        const highlight = i === 0 ? ' style="font-weight: bold; background:#fff7d6;"' : '';
        const tag = (i === 0 && hashtags[key]) ? `<br><span class="hashtag">${hashtags[key]}</span>` : '';
        tbody += `<tr${highlight}><td>${crown}${row.name}${tag}</td><td>${row.count}</td><td>${row.points}</td></tr>`;
      });

      tbody += '</tbody>';
      table.innerHTML = thead + tbody;

      const block = document.createElement('div');
      block.classList.add('category-block');
      const title = document.createElement('h2');
      title.textContent = label;
      block.appendChild(title);
      block.appendChild(table);

      document.getElementById('categories').appendChild(block);
    }

    fetch(SHEET_URL)
      .then(res => res.text())
      .then(csv => {
        const data = parseCSV(csv);

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞—Ç–∏
        let latestDate = null;
        for (const name in data) {
          const rawDate = data[name].updatedAt;
          if (!rawDate) continue;
          const parsed = new Date(rawDate.replace(/(\d{2})\.(\d{2})\.(\d{4})/, '$2/$1/$3'));
          if (!latestDate || parsed > latestDate) latestDate = parsed;
        }

        if (latestDate) {
          const formatted = latestDate.toLocaleDateString('uk-UA', {
            day: '2-digit', month: '2-digit', year: 'numeric'
          });
          document.getElementById('updatedAt').textContent = `–û–Ω–æ–≤–ª–µ–Ω–æ ${formatted}`;
        }

        const tbody = document.getElementById('ratingBody');

        for (const name in data) {
          const monthly = calculateMonthlyPoints(data[name]);
          const previous = +data[name].previousPoints || 0;
          const total = monthly + previous;

          const tr = document.createElement('tr');
          const tdName = document.createElement('td');
          const tdPoints = document.createElement('td');

          const link = document.createElement('a');
          link.href = `waiter.html?name=${encodeURIComponent(name)}`;
          link.textContent = name;

          tdName.appendChild(link);
          tdPoints.innerHTML = `
  <strong>${total}</strong><br>
  <span style="font-size: 13px; color: #888;">
    (–∑ –Ω–∏—Ö ${monthly} ‚Äî —Ü—å–æ–≥–æ –º—ñ—Å—è—Ü—è)
  </span>
`;


          tr.appendChild(tdName);
          tr.appendChild(tdPoints);
          tbody.appendChild(tr);
        }

        // –ö–∞—Ç–µ–≥–æ—Ä—ñ—ó
        renderCategory(data, 'signatureChicken', '–§—ñ—Ä–º–æ–≤–∞ –∫—É—Ä–∫–∞ (√ó2)', 2);
        renderCategory(data, 'newDishes', '–ù–æ–≤–∏–Ω–∫–∏ –º–µ–Ω—é (√ó3)', 3);
        renderCategory(data, 'gomin', '–ì–æ–º—ñ–Ω 0.2 (√ó1)', 1);
        renderCategory(data, 'googleReviews', '–í—ñ–¥–≥—É–∫–∏ –≤ Google (√ó5)', 5);
        renderCategory(data, 'mediaDays', '–ó–π–æ–º–∫–∏ –¥–ª—è —Å–æ—Ü–º–µ—Ä–µ–∂ (√ó20)', 20);
        renderCategory(data, 'substitution', '–ü—ñ–¥–º—ñ–Ω–∏ / —Ñ–æ—Ä—Å-–º–∞–∂–æ—Ä–∏ (√ó10)', 10);
        renderCategory(data, 'proposal', '–†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ —ñ–¥–µ—ó (√ó50)', 50);
      });
  </script>
</body>
</html>
